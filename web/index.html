<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DelayedNotifier ‚Äî –∫–∞–∫ Wildberries, —Ç–æ–ª—å–∫–æ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</title>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #f8f8f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .wb-header {
            background: linear-gradient(90deg, #ff5e8b, #4a90e2); /* –Ø—Ä–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 24px;
            letter-spacing: 0.5px;
        }

        .logo-icon {
            background: white;
            color: #8b57b5;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 800;
        }

        .logo-text {
            text-transform: uppercase;
        }

        .logo-text span {
            font-weight: 300;
            opacity: 0.9;
        }

        .header-tagline {
            margin-left: auto;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 24px;
            flex: 1;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #222;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2:before {
            content: "‚Ä¢";
            color: #8b57b5;
            font-size: 28px;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04);
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #f0f0f0;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1 1 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #444;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="datetime-local"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            transition: 0.2s;
            background: #fafafa;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #8b57b5;
            background: white;
            box-shadow: 0 0 0 3px rgba(139, 87, 181, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .note {
            font-size: 12px;
            color: #888;
            margin-top: 6px;
        }

        .wb-button {
            background: #8b57b5;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
        }

        .wb-button:hover {
            background: #7a49a3;
        }

        .wb-button:active {
            transform: scale(0.98);
        }

        .wb-button.secondary {
            background: white;
            color: #8b57b5;
            border: 1px solid #8b57b5;
            padding: 8px 16px;
            font-size: 14px;
        }

        .wb-button.secondary:hover {
            background: #f3edf9;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .table-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04);
            padding: 8px;
            border: 1px solid #f0f0f0;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 16px;
            overflow: hidden;
        }

        th {
            text-align: left;
            padding: 16px 12px;
            background: #fafafa;
            color: #444;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 14px;
            color: #333;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: #fafafa;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 40px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-scheduled { 
            background: #fff3e0; 
            color: #b45b0f; 
        }
        .status-sent { 
            background: #e3f5e3; 
            color: #1e7e34; 
        }
        .status-failed { 
            background: #ffe6e6; 
            color: #b02a37; 
        }

        .last-error {
            color: #dc3545;
            font-size: 12px;
            max-width: 200px;
            word-break: break-word;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .wb-footer {
            background: white;
            border-top: 1px solid #eee;
            padding: 20px 24px;
            text-align: center;
            color: #777;
            font-size: 13px;
            margin-top: 40px;
        }

        .uid-short {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ Wildberries -->
    <header class="wb-header">
        <div class="logo">
            <div class="logo-icon">WB</div>
            <div class="logo-text">Delayed<span>Notifier</span></div>
        </div>
        <div class="header-tagline">
            <span>‚è∞</span> –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ¬∑ –°–∫–∏–¥–∫–∞ 99% –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ
        </div>
    </header>

    <div class="container">
        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
        <h2>–°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
        <div class="form-card">
            <form id="createForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–∏—Å–ª–æ)</label>
                        <input type="number" id="user_id" name="user_id" min="1" max="1000000" value="1" required
                               placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 12345">
                        <div class="note">‚≠ê –æ—Ç 1 –¥–æ 1‚ÄØ000‚ÄØ000</div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" name="email" placeholder="example@mail.com">
                    </div>
                    <div class="form-group">
                        <label>Telegram</label>
                        <input type="text" id="telegram" name="telegram" placeholder="yournik">
                    </div>
                </div>
                <div class="form-group">
                    <label>–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                    <textarea id="content" name="content" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</label>
                        <input type="datetime-local" id="send_for" name="send_for" required>
                        <div class="note">‚è≥ –º–∏–Ω–∏–º—É–º +1 –º–∏–Ω—É—Ç–∞ –æ—Ç —Å–µ–π—á–∞—Å</div>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="wb-button">
                            <span>‚úö</span> –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
        <h2>–°–æ–∑–¥–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        <div class="table-wrapper">
            <table id="notificationsTable">
                <thead>
                    <tr>
                        <th>UID (–ø–µ—Ä–≤—ã–µ —Å–∏–º–≤–æ–ª—ã)</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>Email</th>
                        <th>Telegram</th>
                        <th>–¢–µ–∫—Å—Ç</th>
                        <th>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                        <th>–û—à–∏–±–∫–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="notificationsBody">
                    <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                </tbody>
            </table>
        </div>
    </div>

    <footer class="wb-footer">
        ‚í∏ DelayedNotifier, 2026 ‚Äî –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤–æ–≤—Ä–µ–º—è, –∫–∞–∫ –∑–∞–∫–∞–∑—ã –Ω–∞ Wildberries
    </footer>

    <script>
        // --- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ø–æ–¥ UUID ---
        const STORAGE_KEY = 'delayedNotifier_notifications_v3'; // –Ω–æ–≤—ã–π –∫–ª—é—á –∏–∑-–∑–∞ —Å–º–µ–Ω—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

        let notifications = []; // –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç uid (—Å—Ç—Ä–æ–∫–∞), user_id, email, telegram, content, send_for (ISO), status, send_at, last_error

        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            renderTable();
            setInterval(refreshAllStatuses, 5000);
        });

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(notifications));
        }

        function loadFromStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    notifications = JSON.parse(stored);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage', e);
                    notifications = [];
                }
            }
        }

        function validateForm(user_id, email, telegram, send_for) {
            if (user_id < 1 || user_id > 1000000) {
                alert('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 1‚ÄØ000‚ÄØ000.');
                return false;
            }
            if (!email.trim() && !telegram.trim()) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–∞–ª: Email –∏–ª–∏ Telegram.');
                return false;
            }
            const scheduledTime = new Date(send_for);
            const now = new Date();
            const minTime = new Date(now.getTime() + 60 * 1000);
            if (scheduledTime < minTime) {
                alert('–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ —Ä–∞–Ω—å—à–µ, —á–µ–º —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞.');
                return false;
            }
            return true;
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user_id = parseInt(document.getElementById('user_id').value, 10);
            const email = document.getElementById('email').value.trim();
            const telegram = document.getElementById('telegram').value.trim();
            const content = document.getElementById('content').value.trim();
            const send_for_local = document.getElementById('send_for').value;

            if (!send_for_local) {
                alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏.');
                return;
            }

            if (!validateForm(user_id, email, telegram, send_for_local)) {
                return;
            }

            const localDate = new Date(send_for_local + ':00');
            const send_for_iso = localDate.toISOString();

            const channels = [];
            if (email) channels.push('email');
            if (telegram) channels.push('telegram');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Notification (—Å —Ç–µ–≥–∞–º–∏ json)
            const payload = {
                user_id: user_id,
                channel: channels,
                content: content,
                send_for: send_for_iso
                // email –∏ telegram –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º, –æ–Ω–∏ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            };

            try {
                const response = await fetch('/notify/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const result = await response.json();
                // –û–∂–∏–¥–∞–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç JSON —Å –ø–æ–ª–µ–º uid (UUID)
                if (!result.uid) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª UID');
                }

                const newNotification = {
                    uid: result.uid,
                    user_id: user_id,
                    email: email,
                    telegram: telegram,
                    content: content,
                    send_for: send_for_iso,
                    status: 'scheduled',
                    send_at: null,
                    last_error: ''
                };
                notifications.push(newNotification);
                saveToStorage();
                renderTable();

                // –°—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                fetchNotificationStatus(result.uid);

                e.target.reset();
                document.getElementById('user_id').value = 1;

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ' + error.message);
            }
        });

        async function fetchNotificationStatus(uid) {
            try {
                const response = await fetch(`/notify/${uid}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        notifications = notifications.filter(n => n.uid !== uid);
                        saveToStorage();
                        renderTable();
                        return;
                    }
                    throw new Error(`HTTP error ${response.status}`);
                }
                const data = await response.json();
                const index = notifications.findIndex(n => n.uid === uid);
                if (index !== -1) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è (—Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å status, send_at, last_error)
                    notifications[index].status = data.status || notifications[index].status;
                    // send_at –º–æ–∂–µ—Ç –±—ã—Ç—å null –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π
                    notifications[index].send_at = data.send_at || null;
                    notifications[index].last_error = data.last_error || '';
                    // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—è, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∏—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, send_for), –Ω–æ –ø–æ–∫–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
                    saveToStorage();
                    renderTable();
                }
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è UID ${uid}:`, error);
            }
        }

        async function refreshAllStatuses() {
            for (const n of notifications) {
                await fetchNotificationStatus(n.uid);
            }
        }

        async function deleteNotification(uid) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?')) return;
            try {
                const response = await fetch(`/notify/${uid}`, { method: 'DELETE' });
                if (!response.ok && response.status !== 404) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                notifications = notifications.filter(n => n.uid !== uid);
                saveToStorage();
                renderTable();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
            }
        }

        function formatDate(isoString) {
            if (!isoString) return '-';
            const d = new Date(isoString);
            return d.toLocaleString();
        }

        function shortenUid(uid) {
            if (!uid) return '-';
            return uid.substring(0, 8) + '‚Ä¶';
        }

        function renderTable() {
            const tbody = document.getElementById('notificationsBody');
            tbody.innerHTML = '';

            if (notifications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 40px;">ü•ù –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –°–∞–º–æ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞—Ç—å!</td></tr>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (–æ—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –∫ –¥–∞–ª—å–Ω–∏–º)
            notifications.sort((a, b) => new Date(a.send_for) - new Date(b.send_for));

            for (const n of notifications) {
                const row = document.createElement('tr');

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞, –Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º content (–æ–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–∞–≤—ã—á–∫–∏)
                const safeContent = n.content.replace(/"/g, '&quot;');
                row.innerHTML = `
                    <td><span class="uid-short" title="${n.uid}">${shortenUid(n.uid)}</span></td>
                    <td>${n.user_id}</td>
                    <td>${n.email || '-'}</td>
                    <td>${n.telegram || '-'}</td>
                    <td title="${safeContent}">${n.content.length > 30 ? n.content.substring(0, 27) + '...' : n.content}</td>
                    <td>${formatDate(n.send_for)}</td>
                    <td><span class="status-badge status-${n.status}">${n.status || 'unknown'}</span></td>
                    <td>${formatDate(n.send_at)}</td>
                    <td>${n.last_error ? `<div class="last-error">${n.last_error}</div>` : '-'}</td>
                    <td class="actions">
                        <button class="refresh-btn" onclick="fetchNotificationStatus('${n.uid}')">‚ü≥</button>
                        <button class="delete-btn" onclick="deleteNotification('${n.uid}')">‚úï</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è onclick
        window.fetchNotificationStatus = fetchNotificationStatus;
        window.deleteNotification = deleteNotification;
    </script>
</body>
</html>